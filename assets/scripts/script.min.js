let notes = [{
    title: "Bem-vindo!",
    content: "Isso é basicamente apenas https://westtle.github.io/simple-note/, mas com mais recursos. Agora você pode adicionar mais notas e removê-las se quiser.\n\nTambém há algumas ferramentas que você pode usar abaixo. Por exemplo, você pode colar da sua área de transferência, copiar, cortar, excluir e habilitar a quebra de linha.",
    id: 0,
    lastOpened: true
}];

const newTabButton = document.querySelector(".new-note_"),
      noteTitleInput = document.querySelector("._title input"),
      noteBody = document.querySelector("._body textarea");

function addTab() {
    let novaAba = document.createElement("button");
    novaAba.classList.add("_tab");
    novaAba.title = "Nova Nota";
    novaAba.innerText = "Nova Nota";
    novaAba.setAttribute("data-id", +new Date());
    novaAba.setAttribute("data-open", "true");
    novaAba.addEventListener("click", openTab);
    document.querySelector(".__tabs").insertBefore(novaAba, newTabButton);

    let novaNota = {
        title: "Nova Nota",
        content: "",
        id: novaAba.dataset.id,
        lastOpened: true
    };

    notes.push(novaNota);
    novaAba.click();
    saveNote();
    noteTitleInput.select();
}

function openTab() {
    let abas = document.querySelectorAll(".__tabs ._tab:not(._tab-tools)"),
        notaAtual = notes.find(nota => nota.id == this.dataset.id);

    abas.forEach(aba => aba.dataset.open = "false");
    this.dataset.open = "true";
    notes.forEach(nota => nota.lastOpened = false);
    notaAtual.lastOpened = true;
    noteTitleInput.value = notaAtual.title;
    noteBody.value = notaAtual.content;
    saveNote();
}

function saveNote() {
    let abaAtual = document.querySelector("[data-open='true']");

    notes.find(nota => {
        if (nota.id == abaAtual.dataset.id) {
            nota.title = noteTitleInput.value;
            nota.content = noteBody.value;
            abaAtual.title = nota.title;

            if (noteTitleInput.value == "") {
                nota.title = "Sem Título";
                abaAtual.textContent = "Sem Título";
                abaAtual.title = "Sem Título";
            } else {
                abaAtual.textContent = nota.title;
            }

            localStorage.setItem("Notes", JSON.stringify(notes));
        }
    });
}

function loadNotes() {
    let notasArmazenadas = JSON.parse(localStorage.getItem("Notes"));
    notes = notasArmazenadas || notes;

    let configNotaArmazenada = JSON.parse(localStorage.getItem("Note Config"));
    noteConfig = configNotaArmazenada || noteConfig;

    noteBody.style.fontSize = noteConfig.fontSize + "rem";
    noteBody.dataset.enableWrap = noteConfig.wordWrap;
    wrapButton.dataset.enableWrap = noteConfig.wordWrap;

    notes.forEach(nota => {
        let novaAba = document.createElement("button");
        novaAba.classList.add("_tab");
        novaAba.title = `${nota.title}`;
        novaAba.innerText = `${nota.title}`;
        novaAba.setAttribute("data-id", `${nota.id}`);
        novaAba.setAttribute("data-open", `${nota.lastOpened}`);
        novaAba.addEventListener("click", openTab);
        document.querySelector(".__tabs").insertBefore(novaAba, newTabButton);
    });

    document.querySelector("[data-open='true']").click();
}

newTabButton.addEventListener("click", addTab);
noteTitleInput.addEventListener("input", () => {
    debouncedsaveNote();
    debouncedtoolMessage("Salvo...");
});
noteBody.addEventListener("input", () => {
    debouncedsaveNote();
    debouncedtoolMessage("Salvo...");
});
document.addEventListener("DOMContentLoaded", () => loadNotes());
